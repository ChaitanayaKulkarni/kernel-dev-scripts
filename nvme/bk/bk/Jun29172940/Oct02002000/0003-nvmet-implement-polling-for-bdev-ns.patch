From 0813a6f09bc16b5330ca8f0bc195b5a73aba7d2e Mon Sep 17 00:00:00 2001
From: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
Date: Tue, 1 Oct 2019 17:30:58 -0700
Subject: [PATCH 3/4] nvmet: implement polling for bdev-ns

Signed-off-by: Chaitanya Kulkarni <chaitanya.kulkarni@wdc.com>
---
 drivers/nvme/target/io-cmd-bdev.c | 32 ++++++++++++++++++++++++++++++-
 1 file changed, 31 insertions(+), 1 deletion(-)

diff --git a/drivers/nvme/target/io-cmd-bdev.c b/drivers/nvme/target/io-cmd-bdev.c
index 32008d85172b..b998df0e2d98 100644
--- a/drivers/nvme/target/io-cmd-bdev.c
+++ b/drivers/nvme/target/io-cmd-bdev.c
@@ -137,13 +137,28 @@ static void nvmet_bio_done(struct bio *bio)
 {
 	struct nvmet_req *req = bio->bi_private;
 
+	if (req->b.polled)
+		complete(&req->b.waiting);
+
 	nvmet_req_complete(req, blk_to_nvme_status(req, bio->bi_status));
 	if (bio != &req->b.inline_bio)
 		bio_put(bio);
 }
 
+static void nvmet_bdev_io_poll_work(struct work_struct *w)
+{
+	struct nvmet_req *req = container_of(w, struct nvmet_req, b.work);
+	struct request_queue *q = bdev_get_queue(req->ns->bdev);
+
+	while (!completion_done(&req->b.waiting)) {
+		blk_poll(q, req->b.cookie, true);
+		io_schedule();
+	}
+}
+
 static void nvmet_bdev_execute_rw(struct nvmet_req *req)
 {
+	struct request_queue *q = bdev_get_queue(req->ns->bdev);
 	int sg_cnt = req->sg_cnt;
 	struct bio *bio;
 	struct scatterlist *sg;
@@ -200,7 +215,18 @@ static void nvmet_bdev_execute_rw(struct nvmet_req *req)
 		sg_cnt--;
 	}
 
-	submit_bio(bio);
+	/* don't even try to poll if q doen't support polling */
+	if (test_bit(QUEUE_FLAG_POLL, &q->queue_flags)) {
+		init_completion(&req->b.waiting);
+		INIT_WORK(&req->b.work, nvmet_bdev_io_poll_work);
+	} else {
+		req->b.polled = false;
+	}
+
+	req->b.cookie = submit_bio(bio);
+
+	if (req->b.polled)
+		queue_work(io_poll_wq, &req->f.work);
 }
 
 static void nvmet_bdev_execute_flush(struct nvmet_req *req)
@@ -318,19 +344,23 @@ u16 nvmet_bdev_parse_io_cmd(struct nvmet_req *req)
 	switch (cmd->common.opcode) {
 	case nvme_cmd_read:
 	case nvme_cmd_write:
+		req->b.polled = true;
 		req->execute = nvmet_bdev_execute_rw;
 		req->data_len = nvmet_rw_len(req);
 		return 0;
 	case nvme_cmd_flush:
+		req->b.polled = false;
 		req->execute = nvmet_bdev_execute_flush;
 		req->data_len = 0;
 		return 0;
 	case nvme_cmd_dsm:
+		req->b.polled = false;
 		req->execute = nvmet_bdev_execute_dsm;
 		req->data_len = (le32_to_cpu(cmd->dsm.nr) + 1) *
 			sizeof(struct nvme_dsm_range);
 		return 0;
 	case nvme_cmd_write_zeroes:
+		req->b.polled = false;
 		req->execute = nvmet_bdev_execute_write_zeroes;
 		req->data_len = 0;
 		return 0;
-- 
2.22.1

